version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: martinmeel-gluetun_server_1
      APP_PORT: 8000

  server:
    image: qmcgaw/gluetun:latest
    container_name: martinmeel-gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      # Gluetun control server
      - 8000:8000
      # Expose ports for other containers to use
      # Sonarr
      - 8989:8989
      # Prowlarr
      - 9696:9696
      # SABnzbd
      - 8080:8080
      # qBittorrent
      - 8090:8090
      # Radarr
      - 7878:7878
    volumes:
      - ${APP_DATA_DIR}/data:/gluetun
    environment:
      # Windscribe VPN Configuration
      VPN_SERVICE_PROVIDER: windscribe
      VPN_TYPE: openvpn
      OPENVPN_USER: ${WINDSCRIBE_USERNAME}
      OPENVPN_PASSWORD: ${WINDSCRIBE_PASSWORD}
      SERVER_REGIONS: ${WINDSCRIBE_REGION:-NL}
      
      # Firewall settings
      FIREWALL_OUTBOUND_SUBNETS: ${NETWORK_SUBNET:-10.21.0.0/16}
      
      # DNS settings
      DOT: "on"
      
      # Control server
      HTTPPROXY: "on"
      SHADOWSOCKS: "off"
      
      # Timezone
      TZ: ${TZ:-UTC}
      
      # Health check URL
      HEALTH_VPN_DURATION_INITIAL: 60s
    restart: unless-stopped
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s